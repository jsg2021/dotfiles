#!/bin/bash
set -e

REGENERATE_LOCKFILE=false
NO_INSTALL=false
PRINT_HELP=false

while true; do
    # echo "Processing option: $1"
    case "$1" in
        -h|--help)
            PRINT_HELP=true
            shift
            ;;
        -r|--regenerate-lockfile)
            REGENERATE_LOCKFILE=true
            shift
            ;;
        -n|--no-install)
            NO_INSTALL=true
            shift
            ;;
        --|'')
            shift || true
            break
            ;;
        *)
            PRINT_HELP=true
            shift || true
            ;;
    esac
done

# echo "Options set: REGENERATE_LOCKFILE=$REGENERATE_LOCKFILE, NO_INSTALL=$NO_INSTALL, PRINT_HELP=$PRINT_HELP"

if $PRINT_HELP; then
    echo "Usage: $0 [--regenerate-lockfile|-r] [--no-install]"
    echo "  --regenerate-lockfile, -r  Regenerate the lock file by deleting it and reinstalling dependencies."
    echo "  --no-install                Skip installing dependencies."
    exit 0
fi


if ! $NO_INSTALL; then
    LOCKFILE_TO_MANAGER=(
        "package-lock.json:npm"
        "yarn.lock:yarn"
        "pnpm-lock.yaml:pnpm"
        "bun.lockb:bun"
        "bun.lock:bun"
    )
    PCK_MGR=""
    for entry in "${LOCKFILE_TO_MANAGER[@]}"; do
        FILE=${entry%%:*}
        MGR=${entry#*:}
        # echo "Checking for $FILE to determine package manager..."
        if [ -f "./$FILE" ]; then
            # echo "Found $FILE, using $MGR as the package manager."
            if command -v "$MGR" &> /dev/null; then      
                PCK_MGR=$MGR
                break
            else 
                echo "Warning: $FILE is not installed. Skipping ${MGR}."
            fi
        fi
    done

    if [ -z "$PCK_MGR" ]; then
        echo "No supported package manager found. Please install npm, yarn, pnpm, or bun."
        exit 1
    fi
fi

if [ -d ./node_modules ]; then
    TEMP_DIR=$(mktemp -d /tmp/node_modules.XXXXXXXXX)
    mv ./node_modules $TEMP_DIR
    rm -rf $TEMP_DIR &
fi

if ! $NO_INSTALL; then
    if $REGENERATE_LOCKFILE; then
        echo "Regenerating lock file..."
        rm -f ./package-lock.json ./yarn.lock ./pnpm-lock.yaml ./bun.lockb ./bun.lock
    fi

    echo "Installing dependencies using $PCK_MGR..."
    $PCK_MGR install
fi